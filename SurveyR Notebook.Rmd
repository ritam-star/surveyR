---
title: "R Notebook for Survey Book"
output: html_notebook
---


<b> Installing Libraries </b>
```{r}
install.packages(c("survey", "srvyr"))
```

<b> Installing More Libraries </b>
```{r}
 install.packages("pak")
 pak::pak("tidy-survey-r/srvyrexploR")
```

<b> Loading Libraries </b> needs to be reloaded every session
```{r}
 library(tidyverse)
 library(survey)
 library(srvyr)
 library(srvyrexploR)
```

Installing more Libraries
```{r}
install.packages(c("gt", "gtsummary"))
```

Loading Libraries
```{r}
library(broom)
library(gt)
library(gtsummary)
```

Installing Census API
```{r}
install.packages("censusapi")
```
Loading Census API
```{r}
library(censusapi)
```
*Storing API key at Sys.setenv(CENSUS_KEY = "key")*
Having a Glimpse ANES 2020 (of the modified survey data in srvyrexploR)
```{r}
anes_2020 %>%
  select(-matches("^V\\d")) %>%
  glimpse()
```
Having a Glimpse RECS 2020 (of the modified survey data in srvyrexploR)
```{r}
recs_2020 %>%
  select(-matches("^NWEIGHT")) %>%
  glimpse()
```
Getting data from Current Population Survey (CPS) using the census key
```{r}
cps_state_in <- getCensus(
  name = "cps/basic/mar",
  vintage = 2020,
  region = "state",
  vars = c(
    "HRMONTH", "HRYEAR4",
    "PRTAGE", "PRCITSHP", "PWSSWGT"
  ),
  key = Sys.getenv("CENSUS_KEY")
)

cps_state <- cps_state_in %>%
  as_tibble() %>%
  mutate(across(
    .cols = everything(),
    .fns = as.numeric
  ))
```

Confirming that the data is from March 2020
```{r}
cps_state %>%
  distinct(HRMONTH, HRYEAR4)
```

Narrowing down Adult US Citizens
```{r}
cps_narrow_resp <- cps_state %>%
  filter(
    PRTAGE >= 18,
    PRCITSHP %in% c(1:4)
  )
```

Calculating the filtered US population
```{r}
targetpop <- cps_narrow_resp %>%
  pull(PWSSWGT) %>%
  sum()

scales::comma(targetpop)
```
anes adjusted weight
```{r}
anes_adjwgt <- anes_2020 %>%
  mutate(Weight = V200010b / sum(V200010b) * targetpop)
```

creating a survey design for anes 2020 (idk what is going on)
```{r}
anes_des <- anes_adjwgt %>%
  as_survey_design(
    weights = Weight,
    strata = V200010d,
    ids = V200010c,
    nest = TRUE
  )

anes_des
```

recs 2020 survey design
```{r}
recs_des <- recs_2020 %>%
  as_survey_rep(
    weights = NWEIGHT,
    repweights = NWEIGHT1:NWEIGHT60,
    type = "JK1",
    scale = 59 / 60,
    mse = TRUE
  )

recs_des
```

using *towny* dataset from {gt} package (why??) [note > when using tidyverse style code make data tibble]
```{r}
towny %>%
  glimpse()
```
```{r}
class(towny)
```

Now working with apistrat dataset (why are we changing datasets??)
```{r}
data(api)

apistrat_des <- apistrat %>%
  as_survey_design(
    strata = stype,
    weights = pw
  )

class(apistrat_des)
```
Now we are seeing how {dplyr} works with regular data frames
```{r}
towny %>%
  summarise(
    area_mean = mean(land_area_km2),
    area_median = median(land_area_km2)
  )
```
Now using *apistrat_des* to also get standard error
```{r}
apistrat_des %>%
  summarize(
    api00_mean = survey_mean(api00),
    api00_med = survey_median(api00)
  )
```

Seeing that {srvyr} sunctions play nicely with tidyverse functions
```{r}
towny %>%
  summarize(across(
    starts_with("population"),
    ~ mean(.x, na.rm = TRUE)
  ))
```
```{r}
apistrat_des %>%
  summarize(across(
    starts_with("api"),
    survey_mean
  ))
```
Flexibity to use {dplyr} verbs with survey design objects
```{r}
apistrat_des_mod <- apistrat_des %>%
  mutate(api_diff = api00 - api99) %>%
  filter(stype == "E") %>%
  select(stype, api99, api00, api_diff, api_students = api.stu)

apistrat_des_mod
```
what is going on??
```{r}
towny %>%
  group_by(csd_type) %>%
  dplyr::summarize(
    area_mean = mean(land_area_km2),
    area_median = median(land_area_km2)
  )
```
Summarising data in {srvyr}
```{r}
apistrat_des %>%
  group_by(stype) %>%
  summarize(
    api00_mean = survey_mean(api00),
    api00_median = survey_median(api00)
  )
```
Alternative way to do grouped analysis on *towny* bby using the .by argument
```{r}
towny %>%
  dplyr::summarize(
    area_mean = mean(land_area_km2),
    area_median = median(land_area_km2),
    .by = csd_type
  )
```
Now .by for {srvyr}
```{r}
apistrat_des %>%
  summarize(
    api00_mean = survey_mean(api00),
    api00_median = survey_median(api00),
    .by = stype
  )
```

Start of Chapter 5 & resetting the variables (why??)
```{r}
#for ANES 2020
targetpop <- 231592693

anes_adjwgt <- anes_2020 %>%
  mutate(Weight = Weight / sum(Weight) * targetpop)

anes_des <- anes_adjwgt %>%
  as_survey_design(
    weights = Weight,
    strata = Stratum,
    ids = VarUnit,
    nest = TRUE
  )
```
```{r}
#for RECS 2020
recs_des <- recs_2020 %>%
  as_survey_rep(
    weights = NWEIGHT,
    repweights = NWEIGHT1:NWEIGHT60,
    type = "JK1",
    scale = 59 / 60,
    mse = TRUE
  )
```

Example 1: Estimated Population Count
```{r}
recs_des %>%
  survey_count()
```
```{r}
recs_des %>%
  survey_tally()
```
Example 2: Estimated Counts by Subgroups
```{r}
recs_des %>%
  survey_count(Region, Division, name = "N")
```

Note: survey_count() syntax wont work with survey_tally()
```{r}
recs_des  %>%
  survey_tally(Region, Division, name = "N")
```
Use a group_by() to fix this
```{r}
recs_des %>%
  group_by(Region, Division) %>%
  survey_tally(name = "N")
```


5.3 Totals and Sums
Example 1 Estimated Population Count
```{r}
recs_des %>%
  summarise(Tot = survey_total())
```

Example 2 Overall summation of continuous variables
```{r}
recs_des %>%
  summarise(elec_bill = survey_total(DOLLAREL))
```
Example 3: Summation by Groups
```{r}
recs_des %>%
  group_by(Region) %>%
  summarise(elec_bill = survey_total(DOLLAREL,
                                     vartype = "ci"
                                     ))
```
Testing something ie testing the difference b/w upp and low (success)
```{r}
difference <- recs_des %>%
  group_by(Region) %>%
  summarise(elec_bill = survey_total(DOLLAREL,
                                     vartype = "ci"
                                     ))
difference$diff <- difference$elec_bill_upp - difference$elec_bill_low

print(difference)
```
5.4 Means and Proportions
5.4.2 Example 1: One variable proportions
```{r}
recs_des %>%
  group_by(Region) %>%
  summarize(p = survey_prop())
```
Example 2: Consitional Proportions
```{r}
recs_des %>%
  group_by(Region, ACUsed) %>%
  summarise(p = survey_prop())
```

Example 3: Joint Proportions
```{r}
recs_des %>%
  group_by(interact(Region, ACUsed)) %>%
  summarise(p = survey_prop())
```
Example 4: Overall Mean
```{r}
recs_des %>%
  summarise(elec_bill = survey_mean(DOLLAREL,
                                    vartype = c("se", "ci")
                                    ))
```
Example 5: Means by Subgroup
```{r}
recs_des %>%
  group_by(Region) %>%
  summarise(elec_bill = survey_mean(DOLLAREL))
```
5.5 Quantiles and Medians
5.5.2 Example 1 Overall Quartiles
```{r}
recs_des %>%
  summarise(elec_bill = survey_quantile(DOLLAREL,
                                        quantiles = c(0.25, 0.5, 0.75)
                                        ))
```
Example 2 Quartiles By Subgroup
```{r}
recs_des %>%
  group_by(Region) %>%
  summarise(elec_bill = survey_quantile(DOLLAREL,
                                        quantiles = c(0.25, 0.5, 0.75)
                                        ))
```
Example 3 Minimum and Maximum
```{r}
recs_des %>%
  summarise(elec_bill = survey_quantile(DOLLAREL,
                                        quantiles = c(0, 1)
                                        ))
```
My example 3.1 Min max by region
```{r}
recs_des %>%
  group_by(Region) %>%
  summarise(elec_bill = survey_quantile(DOLLAREL,
                                        quantiles = c(0, 1)
                                        ))
```
Example 4: Overall Median
```{r}
recs_des %>%
  summarise(elec_bill = survey_median(DOLLAREL))
```
Example 5 Medians by subgroup
```{r}
recs_des %>%
  group_by(Region) %>%
  summarise(elec_bill = survey_median(DOLLAREL))
```
Example 5.6 Rations

Example 1: Overall Ratios
```{r}
recs_des %>%
  summarise(
    DOLLARLP_Tot = survey_total(DOLLARLP, vartype = NULL),
    BTULP_Tot = survey_total(BTULP, vartype = NULL),
    DOL_BTU_Rat = survey_ratio(DOLLARLP, BTULP),
    DOL_BTU_AVG = survey_mean(DOLLARLP / BTULP, na.rm = TRUE)
  )
```
Example 2: Ratios by subgroup
```{r}
recs_des %>%
  group_by(Region) %>%
  summarise(DOL_BTU_Rat = survey_ratio(DOLLARLP, BTULP)) %>%
  arrange(DOL_BTU_Rat)
```
5.7 CORRELATIONS
Example 1: Overall correlations
```{r}
recs_des %>%
  summarise(SQFT_Elec_Corr = survey_corr(TOTSQFT_EN, BTUEL))
```
Example 2: Correlation by subgroup

```{r}
recs_des %>%
  group_by(ACUsed) %>%
  summarise(SQFT_Elec_Corr = survey_corr(TOTSQFT_EN, DOLLAREL))
```
5.8 STANDARD DEVIATION AND VARIANCE
5.8.2 EXample 1: Overall Variability
```{r}
recs_des %>%
  summarise(
    var_elbill = survey_var(DOLLAREL),
    sd_elbill = survey_sd(DOLLAREL)
  )
```

Example 2: Variability by Subgroup
```{r}
recs_des %>%
  group_by(Region) %>%
  summarise(
    var_elbill = survey_var(DOLLAREL),
    sd_elbill = survey_sd(DOLLAREL)
  )
```
5.9 Additional Topics
5.9.1 Unweighted Analysis
```{r}
recs_des %>%
  summarise(
    elec_bill = survey_mean(DOLLAREL),
    elec_unweighted = unweighted(mean(DOLLAREL))
  )
```
5.9.2 Subpopulatioin Analysis
```{r}
recs_des %>%
  filter(BTUNG > 0) %>%
  summarise(NG_mean = survey_mean(DOLLARNG,
                                  vartype = c("se", "ci")
                                  ))
```
5.9.3 Design Effects
```{r}
recs_des %>%
  summarise(across(
    c(BTUEL, BTUNG, BTULP, BTUFO, BTUWOOD),
    ~ survey_mean(.x, deff = TRUE, vartype = NULL)
  )) %>%
  select(ends_with("deff"))
```
5.9.4 Creating Summary Rows
```{r}
recs_des %>%
  cascade(DOLLAREL_mn = survey_mean(DOLLAREL))
```
```{r}
recs_des %>%
  group_by(Region) %>%
  cascade(DOLLAREL_mn = survey_mean(DOLLAREL))
```
```{r}
recs_des %>%
  group_by(Region) %>%
  cascade(DOLLAREL_mn = survey_mean(DOLLAREL),
          .fill = "National")
  

```

```{r}
recs_des %>%
  group_by(Region) %>%
  cascade(DOLLAREL_mn = survey_mean(DOLLAREL),
          .fill = "National",
          .fill_level_top = TRUE
          )
```
5.9.5 Calculating Estimates for many Outcomes
Example 1 ACROSS()
```{r}
consumption_ests <- recs_des %>%
  summarise(across(
    starts_with("BTU"),
    list(
      Total = ~ survey_total(.x, vartype = "cv"),
      Mean = ~ survey_mean(.x, vartype = "cv")
    ),
    .unpack = "{outer}.{inner}"
  ))

consumption_ests
```

```{r}
consumption_ests_long <- consumption_ests %>%
  pivot_longer(
    cols = everything(),
    names_to = c("FuelType", "Stat", "Type"),
    names_pattern = "BTU(.*)_(.*)\\.(.*)"
  )

consumption_ests_long
```

```{r}
consumption_ests_long %>%
  mutate(Type = case_when(
    Type == "coef" ~ "",
    Type == "_cv" ~ " (CV)"
  )) %>%
  pivot_wider(
    id_cols = FuelType,
    names_from = c(Stat, Type),
    names_glue = "{Stat}{Type}",
    values_from = value
  )
```

Example 2: Proportions with Across()
```{r}
recs_des %>%
  group_by(ACUsed) %>%
  summarise(p = survey_prop())
```

```{r}
recs_des %>%
  group_by(SpaceHeatingUsed) %>%
  summarize(p = survey_prop())
```

```{r}
cool_heat_tab <- recs_des %>%
  summarize(across(c(ACUsed, SpaceHeatingUsed), ~ survey_mean(.x),
    .unpack = "{outer}.{inner}"
  ))

cool_heat_tab
```

```{r}
cool_heat_tab %>%
  pivot_longer(everything(),
    names_to = c("Comfort", ".value"),
    names_pattern = "(.*)\\.(.*)"
  ) %>%
  rename(
    p = coef,
    se = `_se`
  )
```

Example 3: PURR::MAP()

```{r}
anes_des %>%
  drop_na(TrustGovernment) %>%
  group_by(TrustGovernment) %>%
  summarise(p = survey_prop() * 100) %>%
  mutate(Variable = "TrustGovernment") %>%
  rename(Answer = TrustGovernment) %>%
  select(Variable, everything())
```
creating a function
```{r}
calcps <- function(var) {
  anes_des %>%
    drop_na(!!sym(var)) %>%
    group_by(!!sym(var)) %>%
    summarise(p = survey_prop() * 100) %>%
    mutate(Variable = var) %>%
    rename(Answer := !!sym(var)) %>%
    select(Variable, everything())
}
```
testing
```{r}
calcps("TrustGovernment")

```
```{r}
calcps("TrustPeople")

```
using map() to iterate over as many variables
```{r}
c("TrustGovernment", "TrustPeople") %>%
  map(calcps) %>%
  list_rbind()
```
5.10 Exercise
1. How many females have a graduate degree? Hint: The variables Gender and Education will be useful.
My solution 1 (checks out)
```{r}
anes_des %>%
  filter(Gender == "Female") %>%
  filter(Education == "Graduate") %>%
  survey_count()

```
My Solution 2 (checks out)
```{r}
anes_des %>%
  group_by(Education) %>%
  filter(Gender == "Female") %>%
  survey_count()
```

Textbook solution
```{r}
# Option 1:
femgd_option1 <- anes_des %>%
  filter(Gender == "Female", Education == "Graduate") %>%
  survey_count(name = "n")

femgd_option1
```
























