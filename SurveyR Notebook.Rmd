---
title: "R Notebook for Survey Book"
output: html_notebook
---


<b> Installing Libraries </b>
```{r}
install.packages(c("survey", "srvyr"))
```

<b> Installing More Libraries </b>
```{r}
 install.packages("pak")
 pak::pak("tidy-survey-r/srvyrexploR")
```

<b> Loading Libraries </b> needs to be reloaded every session
```{r}
 library(tidyverse)
 library(survey)
 library(srvyr)
 library(srvyrexploR)
```

Installing more Libraries
```{r}
install.packages(c("gt", "gtsummary"))
```

Loading Libraries
```{r}
library(broom)
library(gt)
library(gtsummary)
```

Installing Census API
```{r}
install.packages("censusapi")
```
Loading Census API
```{r}
library(censusapi)
```
*Storing API key at Sys.setenv(CENSUS_KEY = "key")*
Having a Glimpse ANES 2020 (of the modified survey data in srvyrexploR)
```{r}
anes_2020 %>%
  select(-matches("^V\\d")) %>%
  glimpse()
```
Having a Glimpse RECS 2020 (of the modified survey data in srvyrexploR)
```{r}
recs_2020 %>%
  select(-matches("^NWEIGHT")) %>%
  glimpse()
```
Getting data from Current Population Survey (CPS) using the census key
```{r}
cps_state_in <- getCensus(
  name = "cps/basic/mar",
  vintage = 2020,
  region = "state",
  vars = c(
    "HRMONTH", "HRYEAR4",
    "PRTAGE", "PRCITSHP", "PWSSWGT"
  ),
  key = Sys.getenv("CENSUS_KEY")
)

cps_state <- cps_state_in %>%
  as_tibble() %>%
  mutate(across(
    .cols = everything(),
    .fns = as.numeric
  ))
```

Confirming that the data is from March 2020
```{r}
cps_state %>%
  distinct(HRMONTH, HRYEAR4)
```

Narrowing down Adult US Citizens
```{r}
cps_narrow_resp <- cps_state %>%
  filter(
    PRTAGE >= 18,
    PRCITSHP %in% c(1:4)
  )
```

Calculating the filtered US population
```{r}
targetpop <- cps_narrow_resp %>%
  pull(PWSSWGT) %>%
  sum()

scales::comma(targetpop)
```
anes adjusted weight
```{r}
anes_adjwgt <- anes_2020 %>%
  mutate(Weight = V200010b / sum(V200010b) * targetpop)
```

creating a survey design for anes 2020 (idk what is going on)
```{r}
anes_des <- anes_adjwgt %>%
  as_survey_design(
    weights = Weight,
    strata = V200010d,
    ids = V200010c,
    nest = TRUE
  )

anes_des
```

recs 2020 survey design
```{r}
recs_des <- recs_2020 %>%
  as_survey_rep(
    weights = NWEIGHT,
    repweights = NWEIGHT1:NWEIGHT60,
    type = "JK1",
    scale = 59 / 60,
    mse = TRUE
  )

recs_des
```

using *towny* dataset from {gt} package (why??) [note > when using tidyverse style code make data tibble]
```{r}
towny %>%
  glimpse()
```
```{r}
class(towny)
```

Now working with apistrat dataset (why are we changing datasets??)
```{r}
data(api)

apistrat_des <- apistrat %>%
  as_survey_design(
    strata = stype,
    weights = pw
  )

class(apistrat_des)
```
Now we are seeing how {dplyr} works with regular data frames
```{r}
towny %>%
  summarise(
    area_mean = mean(land_area_km2),
    area_median = median(land_area_km2)
  )
```
Now using *apistrat_des* to also get standard error
```{r}
apistrat_des %>%
  summarize(
    api00_mean = survey_mean(api00),
    api00_med = survey_median(api00)
  )
```

Seeing that {srvyr} sunctions play nicely with tidyverse functions
```{r}
towny %>%
  summarize(across(
    starts_with("population"),
    ~ mean(.x, na.rm = TRUE)
  ))
```
```{r}
apistrat_des %>%
  summarize(across(
    starts_with("api"),
    survey_mean
  ))
```
Flexibity to use {dplyr} verbs with survey design objects
```{r}
apistrat_des_mod <- apistrat_des %>%
  mutate(api_diff = api00 - api99) %>%
  filter(stype == "E") %>%
  select(stype, api99, api00, api_diff, api_students = api.stu)

apistrat_des_mod
```
what is going on??
```{r}
towny %>%
  group_by(csd_type) %>%
  dplyr::summarize(
    area_mean = mean(land_area_km2),
    area_median = median(land_area_km2)
  )
```
Summarising data in {srvyr}
```{r}
apistrat_des %>%
  group_by(stype) %>%
  summarize(
    api00_mean = survey_mean(api00),
    api00_median = survey_median(api00)
  )
```
Alternative way to do grouped analysis on *towny* bby using the .by argument
```{r}
towny %>%
  dplyr::summarize(
    area_mean = mean(land_area_km2),
    area_median = median(land_area_km2),
    .by = csd_type
  )
```
Now .by for {srvyr}
```{r}
apistrat_des %>%
  summarize(
    api00_mean = survey_mean(api00),
    api00_median = survey_median(api00),
    .by = stype
  )
```

Start of Chapter 5 & resetting the variables (why??)
```{r}
#for ANES 2020
targetpop <- 231592693

anes_adjwgt <- anes_2020 %>%
  mutate(Weight = Weight / sum(Weight) * targetpop)

anes_des <- anes_adjwgt %>%
  as_survey_design(
    weights = Weight,
    strata = Stratum,
    ids = VarUnit,
    nest = TRUE
  )
```
```{r}
#for RECS 2020
recs_des <- recs_2020 %>%
  as_survey_rep(
    weights = NWEIGHT,
    repweights = NWEIGHT1:NWEIGHT60,
    type = "JK1",
    scale = 59 / 60,
    mse = TRUE
  )
```

Example 1: Estimated Population Count
```{r}
recs_des %>%
  survey_count()
```
```{r}
recs_des %>%
  survey_tally()
```
Example 2: Estimated Counts by Subgroups
```{r}
recs_des %>%
  survey_count(Region, Division, name = "N")
```

Note: survey_count() syntax wont work with survey_tally()
```{r}
recs_des  %>%
  survey_tally(Region, Division, name = "N")
```
Use a group_by() to fix this
```{r}
recs_des %>%
  group_by(Region, Division) %>%
  survey_tally(name = "N")
```


5.3 Totals and Sums
Example 1 Estimated Population Count
```{r}
recs_des %>%
  summarise(Tot = survey_total())
```

Example 2 Overall summation of continuous variables
```{r}
recs_des %>%
  summarise(elec_bill = survey_total(DOLLAREL))
```
Example 3: Summation by Groups
```{r}
recs_des %>%
  group_by(Region) %>%
  summarise(elec_bill = survey_total(DOLLAREL,
                                     vartype = "ci"
                                     ))
```
Testing something ie testing the difference b/w upp and low (success)
```{r}
difference <- recs_des %>%
  group_by(Region) %>%
  summarise(elec_bill = survey_total(DOLLAREL,
                                     vartype = "ci"
                                     ))
difference$diff <- difference$elec_bill_upp - difference$elec_bill_low

print(difference)
```
5.4 Means and Proportions
5.4.2 Example 1: One variable proportions
```{r}
recs_des %>%
  group_by(Region) %>%
  summarize(p = survey_prop())
```
Example 2: Consitional Proportions
```{r}
recs_des %>%
  group_by(Region, ACUsed) %>%
  summarise(p = survey_prop())
```

Example 3: Joint Proportions
```{r}
recs_des %>%
  group_by(interact(Region, ACUsed)) %>%
  summarise(p = survey_prop())
```
Example 4: Overall Mean
```{r}
recs_des %>%
  summarise(elec_bill = survey_mean(DOLLAREL,
                                    vartype = c("se", "ci")
                                    ))
```
Example 5: Means by Subgroup
```{r}
recs_des %>%
  group_by(Region) %>%
  summarise(elec_bill = survey_mean(DOLLAREL))
```
5.5 Quantiles and Medians





